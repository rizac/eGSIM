{% extends 'base.html' %}

{% block head %}

{% with vue=True plotly=True leaflet=True fontawesome=True %}
{{ block.super }}
{% endwith %}

<style>
	@media (max-width: 975px){  /* narrow  screen (< 975px) */
		nav > .menu-item span { display: none !important; } /* hide menu texts */
	}
	/* waitbar. For info see: https://www.pexels.com/blog/css-only-loaders/ */
	.loader, .loader:before { height: 10px; }
	.loader {
		width: 100%;
		position: relative;
		overflow: hidden;
		background-color: #999;
	}
	.loader:before{
		display: block;
		position: absolute;
		content: "";
		left: -200px;
		width: 200px;
		background-color: #ffc107; /*#a2cd7e;*/
		animation: loading 2s linear infinite;
	}
	@keyframes loading {
		from {left: -200px; width: 30%;}
		50% {width: 30%;}
		70% {width: 70%;}
		80% { left: 50%;}
		95% {left: 120%;}
		to {left: 100%;}
	}
</style>

{% endblock %}


{% block body %}
<div class="d-flex flex-column bg-body" id='egsim-vue' style="height: 100vh;">
	<template v-if="showNavBar">
	{% include "navbar.html" %}
	</template>
	<!-- FIXME REMOVE BELOW -->
<!--	<button type='button' onclick="fetch('test_request').then(r => r.json()).then(d => { console.log(d); })">Test request</button>-->
	<keep-alive>
	<template v-if="currentPage==pages.predictions">
	{% include "trellis.html" %}
	</template>
	<template v-else-if="currentPage==pages.flatfile_info">
	{% include "flatfile_info.html" %}
	</template>
	<template v-else-if="currentPage==pages.flatfile_visualizer">
	{% include "flatfile_visualizer.html" %}
	</template>
	<template v-else-if="currentPage==pages.residuals">
	{% include "residuals.html" %}
	</template>
	<template v-else-if="currentPage==pages.ref_and_license">
	{% include "ref_and_license.html" %}
	</template>
	<template v-else-if="currentPage==pages.imprint">
	{% include "imprint.html" %}
	</template>
	<template v-else>
	{% include "home.html" %}
	</template>
	</keep-alive>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
		crossorigin="anonymous"></script>

{% endblock %}

{% block after-body %}

{{ block.super }}

<script>
const origFetch = window.fetch;
window.fetch = function() {
	var args = Array.from(arguments);
	if (args.length == 1){
		args.push({});
	}
	var options = args[1];
	if (!options.headers){
		options.headers = {};
	}
	options.headers["X-CSRFToken"] = "{{ csrf_token }}";

	// setup the load bar <div>
	var bar = document.getElementById('loadbar');
	bar.style.display = '';

	return new Promise((resolve, reject) => {  // https://stackoverflow.com/a/53448336
		origFetch.apply(this, args).then((response) => {
			if (!response.ok){
				// status code 4xx or 5xx: show msg and then treat it like an error (fetch doesn't by default)
				response.clone().json().then(data => showFetchError(data.message));
				reject(response);
			}else{
				resolve(response);
			}
		}).catch((error) => {
			// some network error (Note: NOT 4xx or 5xx responses!)
			showFetchError("" + error);
			reject(error);
		}).finally(() => {
			bar.style.display = 'none';
		});
	});
}

function showFetchError(msg){
	let div = document.body;
	let alert = document.createElement('div');
	alert.innerHTML = `{% include "alert.html" with content="${msg}" %}`;
	div.appendChild(alert);
}
</script>

<!-- VUE.JS: -->
<!--<script type='text/javascript' src = "{% static 'js/egsim.js' %}"></script>-->

{{ init_data | json_script:"init-data" }}

<script type="text/javascript">
function getInitData(){
	const data = JSON.parse(document.getElementById('init-data').textContent);
	// converts the gsims received from server from an Array of Arrays to an
	// Array of Objects:
	var imts = new Set();
	data.imt_groups.forEach(imtz => imtz.forEach(i => imts.add(i)));
	var models = data.gsims.map(elm => {  // elm: Array of 2 or 3 elements: name, imt_group, warning
		return {
			name: elm[0],
			imts: new Set(data.imt_groups[elm[1]]),
			warning: elm[2] ? data.warning_groups[elm[2]]: "",
		}
	});
	var currentPage = data.currentPage || 'home';  // one of the key of the Objet 'tab' below
	return {
		models: Object.freeze(models),
		imts: Array.from(imts),
		forms: data.forms,
		urls: data.urls,
		regionalizations: data.regionalizations,
		flatfiles: data.flatfiles,
		showNavBar: true,
		pages: data.pages,  // dict of key -> page URL (relative to the base URL of the site)
		currentPage: currentPage,
	}
}

const EGSIM = Vue.createApp({
	watch:{
		currentPage:{
			immediate: true,
			handler(newVal, oldVal){
				this.showNavBar = newVal != this.pages.home;
				this.setUrlInBrowser(newVal)
			}
		}
	},
	data: getInitData,
	methods: {
		setUrlInBrowser(menu){
			var location = window.location;
			if (!location.pathname.startsWith(`/${menu}`)){
				var newHref = `${location.origin}/${menu}`
				// https://developer.mozilla.org/en-US/docs/Web/API/History_API
				window.history.replaceState({}, document.title, newHref);
			}
			return false; // in case accessed from within anchors
		},
	}
});

</script>
<!-- Components and dependencies of the EGISM app: -->
<script type='text/javascript' src="{% static 'js/vue/components.js' %}"></script>
<script type='text/javascript' src="{% static 'js/vue/plots-div.js' %}"></script>
<script>
/* mount the Vue App EGSIM. The function below returns an App instance (not used for the moment): */
EGSIM.mount('#egsim-vue');
</script>
{% endblock %}
